# Журнал Дежурства

Система совместной работы над задачами для сменных работников.

## Для чего?

 - Для совместной работы над задачами сменными работниками, особенно когда они не встречаются лично.
 - Учет выполнения задач.
 - "Передача смены" с генерацией отчета в формате Excel.
 - Ознакомление работников с задачами, поручениями и документами с фиксацией времени ознакомления.


## Особенности

- Контроль ознакомления пользователей с задачами и сообщениями о ходе их выполнения.
- Поток уведомлений (activity stream) о действиях пользователей в разделе "Журнал".
- Передача уведомлений для оперативного обновления фронтенда через WebSockets.
- Уведомление админов о событиях через Телеграм-бота.
- Разные варианты интерфейса, подходящие для разных ситуаций: классические server-side rendered Django-templates,
удобные для работы с мобильных устройств или вывода на печать, и полноценное приложение на **Vue 3** для динамичной
работы с задачами и комментариями с десктопа.
- Сохранение предыдущей версии задачи, комментария при их изменении.
- Архив задач и комментариев (пользователи не могут их удалить бесследно).
- Архив отчетов в формате Excel.
- Личные задачи пользователей.
- Быстрый поиск по задачам и комментариям к ним.
- Поддержка [Markdown](https://daringfireball.net/projects/markdown/basics) в задачах, комментариях и поручениях.

## Используемые технологии, фреймворки и библиотеки

### Backend

| Библиотека / фреймворк      | Ссылки                                              | Описание                                                                                                                                                                          |
|-----------------------------|-----------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Python 3.10                 | Сайт                                                | Весь бэкенд написан на Python.                                                                                                                                                    |
| Django 4                    | [Docs](https://www.djangoproject.com)               | В основе всего приложения лежит замечательный фреймворк **Django**.                                                                                                               |
| - Gunicorn                  | [Docs](https://gunicorn.org)                        | Description                                                                                                                                                                       |
| - `whitenoise`              | Docs                                                | Раздача статических файлов.                                                                                                                                                       |
| - `django-notifications-hq` | Docs                                                | Журнал активности пользователей.                                                                                                                                                  |
| - `XlsxWriter`              | Docs                                                | Генерация отчетов в формате Excel.                                                                                                                                                |
| - `Markdown`                | [Docs](https://python-markdown.github.io/)          | Разметка Markdown в задачах, комментариях и поручениях.                                                                                                                           |
| - `django-bleach`           | Docs                                                | Очистка от HTML-тегов информации, вводимой на сайте пользователями, за исключением перечня допустимых тегов.                                                                      |
| - `djangorestframework`     | Docs                                                | API для Vue-фронтенда.                                                                                                                                                            |
| - `Django-Channels`         | [Docs](https://channels.readthedocs.io/en/stable/)  | Description                                                                                                                                                                       |
| - `channels-redis`          | [GitHub](https://github.com/django/channels_redis/) | Description                                                                                                                                                                       |
| - `Daphne`                  | [GitHub](https://github.com/django/daphne/)         | Description                                                                                                                                                                       | 
| - SQLite                    | [Docs](https://sqlite.org/index.html)               | Проект не рассчитывался на значительное количество одновременно работающих пользователей, поэтому выбрана данная БД из-за её простоты, удобства отладки и резервного копирования. | 
| Redis                       | Docs                                                | Description                                                                                                                                                                       |
| Celery                      | Docs                                                | Description                                                                                                                                                                       | 
| Nginx                       | [Docs](https://www.nginx.com)                       | Info                                                                                                                                                                              |  
| Docker Compose              | [Docs](https://docs.docker.com/compose/)            | Info                                                                                                                                                                              |

### Frontend

| Библиотека / фреймворк | Ссылки                                      | Описание                                                                                                     |
|------------------------|---------------------------------------------|--------------------------------------------------------------------------------------------------------------|
| Bootstrap 5            | [Docs](https://getbootstrap.com)            | Info                                                                                                         |
| Font Awesome           | [Docs](https://fontawesome.com)             | Info                                                                                                         |
| HTMX 1.8.4             | [Docs](https://htmx.org)                    | Info                                                                                                         |
| Vue 3                  | [Docs](https://vuejs.org)                   | Используется для создания удобного реактивного интерфейса для работы со списком задач и комментариями к ним. |
| Axios                  | [Docs](https://github.com/axios/axios)      | Info                                                                                                         |
| Marked.js              | [Docs](https://marked.js.org)               | Info                                                                                                         |
| DOMPurify              | [Docs](https://github.com/cure53/DOMPurify) | Info                                                                                                         |

### Developer Tools

- [Coverage.py](https://coverage.readthedocs.io/en/7.2.1/)
- [Interrogate](http://interrogate.readthedocs.io)
- [Rollbar](https://rollbar.com) - логирование ошибок при работе веб-приложения в продакшен.


## Деплой

Для установки и запуска проекта, необходимо склонировать репозиторий, создать файл `docker-compose.yml` по одному из 
прилагаемых шаблонов (`dev` или `prod`), задать в нём корректные переменные окружения, и затем запустить командой 
`sudo docker compose up -d`.  При первом запуске необходимо также выполнить команду миграции БД и создать учетную запись 
администратора:

```bash
  git clone ttps://github.com/hazadus/journal
  cd ./journal
  cp ./docker-compose.prod.yml ./docker-compose.yml
  nano ./docker-compose.yml
  sudo docker compose up -d --build
  sudo docker exec journal-web python -m manage migrate
  sudo docker exec journal-web python -m manage createsuperuser
```


## Переменные окружения
Для корректного запуска проекта, необходимо установить следующие переменные окружения в файле `docker-compose.yml`:

| Переменная             | Значение                                                                                                   |
|------------------------|------------------------------------------------------------------------------------------------------------|
| `SECRET_KEY`           | Стандартный secret key для Django.                                                                         |
| `HOST_NAME`            | Адрес сайта вида `http://127.0.0.1` (без `/` на конце).                                                    |
| `ROLLBAR_ACCESS_TOKEN` | Токен [Rollbar](https://rollbar.com), необходимо получить на их сайте.                                     |
| `TELEGRAM_BOT_TOKEN`   | Токен телеграм-бота для информирования. От имени этого бота будут отправляться уведомления администратору. |
| `TELEGRAM_ADMIN_ID`    | ID админа в телеграм, который будет получать уведомления о событиях на сайте.                              |

## Структура проекта Django

Django apps:
- `journal`
- `documents`
- `users`
- `core`

Директории и файлы:
- `vue-tasks-table-view` - приложение на Vue для варианта табличного вида списка задач
- `static/vue/task-table-view` - сюда генерятся файлы при сборке приложения Vue командой `npm run build`.
- `db.sqlite3` - файл БД.
- `media/files` - файлы, загружаемые в качестве приложений к задачам и документам.
- `media/images` - изображения профилей пользователей.
- `media/reports` - отчеты, генерируемые командой `create_report`.
- `data/redis` - данные БД Redis.
- `docker/nginx/default.conf` - конфигурационный файл Nginx.
- `docker/nginx/logs/` - логи Nginx.
- `.coveragerc` - настройки `coverage.py`
- `htmlcov/` - отчеты `coverage.py` (генерируются при запуске `make up`, `make test`).

### Дополнительные команды `manage.py`

|     Команда     | Описание                                                                                                                                                                                                                                                                                                                                                                  |
|:---------------:|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `create_report` | Создаёт отчет `О передаче смены` по текущим задачам и комментариям к ним в формате Excel. Генерирует файл Excel, в который выводятся активные на текущий момент задачи (каждая задача на отдельном листе) и все комментарии к ним. К файлу отчета создаётся запись в БД, и рассылаются уведомления о генерации отчета. Файлы сохраняются в директории `./media/reports/`. |

## Запуск тестов

Тесты запускаются стандартной для Django командой при запущенном в фоне (с опцией `-d`) проекте:

```bash
  docker exec journal-web python -m manage test
```

Для запуска с `coverage.py`:
```bash
  docker exec journal-web coverage run --source='.' -m manage test
  docker exec journal-web coverage html
```


## Планируемые доработки

Все запланированые изменения и доработки можно увидеть в разделе
[Issues](https://github.com/hazadus/journal/issues).

## Известные проблемы
- Из-за особенностей работы SQLite с кириллицей, поиск по задачам и комментариям к ним чувствителен к регистру 
кириллических символов в поисковом запросе.